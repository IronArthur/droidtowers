<?xml version="1.0" encoding="UTF-8"?>
<project name="DroidTowers" default="build-all-platforms">
  <property name="compiler.debug" value="off"/>
  <property file="build.properties"/>

  <property name="root.dir" value="."/>
  <property name="src.dir" value="source"/>
  <property name="build.dir" value="out/desktop-jar"/>
  <property name="classes.dir" value="${build.dir}/classes"/>

  <path id="classpath">
    <fileset dir="${root.dir}/main/libs/main" includes="**/*.jar"/>
    <fileset dir="${root.dir}/desktop/libs/main" includes="**/*.jar"/>
  </path>

  <target name="clean">
    <delete dir="${build.dir}"/>
  </target>

  <target name="compile">
    <mkdir dir="${classes.dir}"/>
    <mkdir dir="${build.dir}/tool-classes"/>

    <javac srcdir="${root.dir}/pipeline/src" destdir="${build.dir}/tool-classes/" classpathref="classpath"
           failonerror="true"/>
    <java classname="com.unhappyrobot.pipeline.GenerateAssetManagerFileList" classpath="${build.dir}/tool-classes/"
          failonerror="true" classpathref="classpath" fork="true" dir="${root.dir}/android"/>

    <javac srcdir="${root.dir}/main/${src.dir}" destdir="${classes.dir}" classpathref="classpath"/>
    <javac srcdir="${root.dir}/desktop/${src.dir}" destdir="${classes.dir}" classpathref="classpath"/>
  </target>

  <target name="jar" depends="compile">
    <jar destfile="${build.dir}/${ant.project.name}-release.jar" basedir="${build.dir}/classes"
         filesetmanifest="mergewithoutmain">
      <manifest>
        <attribute name="Main-Class" value="com.unhappyrobot.DesktopGame"/>
        <attribute name="Class-Path" value="."/>
      </manifest>
      <fileset dir="${build.dir}/classes"/>
      <zipgroupfileset dir="${root.dir}/main/libs/main" includes="**/*.jar"/>
      <zipgroupfileset dir="${root.dir}/desktop/libs/main" includes="**/*.jar"/>
      <zipfileset dir="${root.dir}/android/assets/"/>
    </jar>
  </target>

  <target name="multi-jar" depends="compile">
    <jar destfile="${build.dir}/${ant.project.name}-gamecode.jar" basedir="${build.dir}/classes"
         filesetmanifest="mergewithoutmain" level="9">
      <manifest>
        <attribute name="Main-Class" value="com.unhappyrobot.DesktopGame"/>
        <attribute name="Class-Path" value="."/>
      </manifest>
      <fileset dir="${build.dir}/classes"/>
    </jar>
    <jar destfile="${build.dir}/${ant.project.name}-libs-main.jar"
         filesetmanifest="mergewithoutmain" level="9">
      <zipgroupfileset dir="${root.dir}/main/libs/main" includes="**/*.jar"/>
    </jar>
    <jar destfile="${build.dir}/${ant.project.name}-libs-desktop.jar"
         filesetmanifest="mergewithoutmain" level="9">
      <zipgroupfileset dir="${root.dir}/desktop/libs/main" includes="**/*.jar"/>
    </jar>
    <jar destfile="${build.dir}/${ant.project.name}-assets.jar"
         filesetmanifest="mergewithoutmain" level="9">
      <zipfileset dir="${root.dir}/android/assets/"/>
    </jar>
  </target>

  <target name="build" depends="clean,jar"/>

  <target name="osx" depends="build" description="Build an OSX target">
    <property file="release.properties"/>

    <taskdef name="jarbundler"
             classpath="./tools/jarbundler-2.2.0.jar"
             classname="net.sourceforge.jarbundler.JarBundler"/>

    <jarbundler dir="${basedir}/out/" verbose="false" showPlist="false"
                name="${ant.project.name}"
                mainclass="com.unhappyrobot.DesktopGame"
                jar="${build.dir}/${ant.project.name}-release.jar"
                icon="icons/${ant.project.name}.icns"
                version="${project.version}"/>

    <delete dir="${artifacts.temp.dir}"/>
  </target>

  <property name="launch4j.dir" location="./tools/launch4j"/>

  <target name="exe" depends="build" description="Build a Windows target">
    <property file="release.properties"/>

    <taskdef name="launch4j"
             classname="net.sf.launch4j.ant.Launch4jTask"
             classpath="${launch4j.dir}/launch4j.jar:${launch4j.dir}/lib/xstream.jar"/>

    <launch4j configfile="./desktop/targets/windows/config.xml"/>
  </target>

  <target name="build-all-platforms" depends="clean,exe,osx">
    <delete file="${basedir}/out/${ant.project.name}.zip" failonerror="false"/>
    <exec executable="zip" dir="${basedir}/out" output="/dev/null">
      <arg value="-rX"/>
      <arg value="DroidTowers.zip"/>
      <arg value="DroidTowers.app"/>
    </exec>
  </target>
</project>
